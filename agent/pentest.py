"""
deepagents_hitl_runner.py

Example runner that creates a DeepAgent with nmap/sqlmap tools and forces
Human-In-The-Loop approval for any tool calls.

Requirements:
  pip install deepagents langgraph
  (and your nmap/sqlmap tools files should be importable)
"""

from deepagents import create_deep_agent
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.types import Command
import json
import uuid
from langchain.chat_models import init_chat_model

# Internal
from services.io_service import safe_parse_int_input, print_menu, notify
from agent.prompt.master_instruction import SYSTEM_PROMPT

# Replace these imports with the actual module paths where you saved the tools.
# Example: from tools.nmap_tool_langchain import nmap_tool
#          from tools.sqlmap_tool_deepagents import sqlmap_tool
# from nmap_tool_langchain import nmap_tool
# from sqlmap_tool_deepagents import sqlmap_tool
from tools import nmap, sqlmap, mssql, authenticate


def build_agent(model="gemini-2.0-flash", provider="google_genai"):
    """
    Create the deep agent with HITL enforcement for sensitive tools.
    tool_configs maps tool-name -> HumanInTheLoopConfig (True == full allow).
    """
    # Init the chat model
    llm = init_chat_model(model=model, model_provider=provider)

    nmap = nmap.make_langchain_tool()
    sqlmap = sqlmap.make_langchain_tool()
    mssql_auth = authenticate.make_langchain_tool()

    # We name the tools by their function name: nmap_tool, sqlmap_tool
    tools = [nmap, sqlmap, mssql_auth]

    # Require human approval/edit/respond for both tools.
    # Setting True is a shortcut that allows accept/edit/respond.
    tool_configs = {
        "nmap_tool": True,
        "sqlmap_tool": True,
        "mssql_check_credentials": True,
    }

    agent = create_deep_agent(
        tools=tools,
        instructions=SYSTEM_PROMPT,
        tool_configs=tool_configs,
        model=llm,
    )

    # Attach an in-memory checkpointer so Human-in-the-Loop works locally.
    checkpointer = InMemorySaver()
    agent.checkpointer = checkpointer

    return agent


def prompt_human_for_resume():
    """
    Ask operator what to do when agent pauses for approval.
    Returns a `resume` list as expected by Command(resume=[...])
    """
    menu_title = "\nPlease choose an action:"
    menu_items = [
        "accept         -> allow the tool to run as-is",
        "edit           -> edit which tool/args to run",
        "response       -> do NOT run tool, instead append a textual response to the agent",
        "abort          -> stop the agent entirely",
    ]
    print_menu(menu_items, menu_title)

    choice = safe_parse_int_input(">", min_value=1, max_value=len(menu_items))
    if choice == "1":
        return [{"type": "accept"}]
    elif choice == "2":
        # For edit, operator provides JSON like: {"action": "nmap_tool", "args": {"target":"1.2.3.4","arguments":"-sV -p80"}}
        print("\nEnter edited tool call as JSON.")
        print(
            'Example: {"action":"nmap_tool","args":{"target":"192.168.1.100","arguments":"-sV -p22,80"}}'
        )
        raw = input("Edited call JSON: ").strip()
        try:
            payload = json.loads(raw)
            # Basic validation
            if "action" not in payload or "args" not in payload:
                raise ValueError("must include 'action' and 'args' keys")
            return [{"type": "edit", "args": payload}]
        except Exception as e:
            print("Invalid JSON / format:", e)
            print("Falling back to respond with a message instead.")
            return [
                {
                    "type": "response",
                    "args": "Operator provided invalid edit; aborting tool call.",
                }
            ]
    elif choice == "3":
        text = input(
            "Enter textual response to append (this will NOT run the tool): "
        ).strip()
        return [{"type": "response", "args": text}]
    else:
        # abort / anything else -> send a response indicating abort
        return [{"type": "response", "args": "Operator aborted the test."}]


def run_interactive_scan(agent, user_prompt: str):
    """
    Run the agent on `user_prompt`. This demo runs until the agent reaches a HITL interrupt,
    then prompts the user and resumes with the chosen Command.
    """
    thread_id = str(uuid.uuid4())
    config = {"configurable": {"thread_id": thread_id}}

    notify("Starting agent (will pause when a tool requiring approval is proposed)...\n")
    # First pass: agent.stream will go until it hits an interrupt and then return control
    for chunk in agent.stream(
        {"messages": [{"role": "user", "content": user_prompt}]}, config=config
    ):
        # In a real UI you would render chunk contents progressively. Here we print.
        print("STREAM CHUNK 1:", chunk)
        # print(format_stream_chunk(chunk))

    # When the agent paused for human approval, we now ask the operator what to do
    resume_payload = prompt_human_for_resume()

    print("\nResuming agent with operator decision...\n")
    # Resume by sending the Command with resume payload.
    for chunk in agent.stream(Command(resume=resume_payload), config=config):
        print("STREAM CHUNK 2:", chunk)
        # print(format_stream_chunk(chunk))

    
    # When the agent paused for human approval, we now ask the operator what to do
    resume_payload = prompt_human_for_resume()

    print("\nResuming agent with operator decision...\n")
    # Resume by sending the Command with resume payload.
    for chunk in agent.stream(Command(resume=resume_payload), config=config):
        print("STREAM CHUNK 3:", chunk)
        # print(format_stream_chunk(chunk))

    print("\nAgent run complete.")


def format_stream_chunk(chunk):
    """
    Formats the STREAM CHUNK dictionary into a readable string.

    Args:
        chunk (dict): The STREAM CHUNK dictionary.

    Returns:
        str: A formatted string representation of the chunk.
    """
    import json

    def safe_serialize(obj):
        """Safely serialize objects that are not JSON serializable."""
        try:
            return json.dumps(obj, indent=2)
        except TypeError:
            return str(obj)

    if not isinstance(chunk, dict):
        return str(chunk)

    formatted_output = []

    if "agent" in chunk:
        formatted_output.append("Agent Messages:")
        for message in chunk["agent"].get("messages", []):
            # Handle AIMessage objects
            if hasattr(message, "content"):
                content = getattr(message, "content", "No content")
            else:
                content = message.get("content", "No content")
            formatted_output.append(f"  - {content}")

    if "tools" in chunk:
        formatted_output.append("\nTools:")
        for tool, details in chunk["tools"].items():
            formatted_output.append(f"  {tool}:")
            if isinstance(details, list):
                for item in details:
                    formatted_output.append(f"    - {safe_serialize(item)}")
            else:
                formatted_output.append(f"    {safe_serialize(details)}")

    if "__interrupt__" in chunk:
        formatted_output.append("\nInterrupt:")
        interrupt_details = chunk["__interrupt__"]
        formatted_output.append(f"  {safe_serialize(interrupt_details)}")

    if "post_model_hook" in chunk:
        formatted_output.append("\nPost Model Hook: None")

    return "\n".join(formatted_output)


if __name__ == "__main__":
    print("=== DeepAgents HITL demo runner ===")
    agent = build_agent()

    # Operator must explicitly confirm they have permission to test the target.
    ok = (
        input(
            "Do you confirm you have authorization to test systems you will specify? [yes/no]: "
        )
        .strip()
        .lower()
    )
    if ok not in ("y", "yes"):
        print("Authorization not confirmed. Exiting.")
        exit(1)

    # Example prompt (modify as desired)
    prompt = input(
        "Enter the security testing instruction for the agent (e.g. 'Scan 192.168.1.100 for open ports and vulnerabilities'):\n"
    )

    run_interactive_scan(agent, prompt)
